#!/bin/sh

#
# recordctl - Enable/disable audio recording in the OpenBSD kernel
#
# CHANGE LOG:
#
# v0.1   - 2024-07-29 - Morgan Aldridge <morgant@makkintosshu.com>
#                       Initial version.
# v0.1.1 - 2024-08-10 - Morgan Aldridge
#                       Added Makefile and manual page.
# v0.2   - 2024-09-06 - Morgan Aldridge
#                       Exit with an error if not run as root and without
#                       permitted by doas(1), automatically use doas(1) if
#                       permitted, and added '-n' non-interactive option to
#                       require 'nopass' in doas.conf(5).
#
# LICENSE:
#
# Copyright (c) 2024 Morgan Aldridge
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

quiet=""
mode="set"
nopass="false"
audio=false
video=false
state=""
action=""
doas_cmd=""

usage() {
  echo "Usage: $(basename "$0") [-q] [-t | -m] [-n] [-a] [-v] <state>"
}

_is_sysctl_permitted() {
  _permitted=true

  # in non-interactive/nopass mode, we must match for the whole "permit nopass"
  # otherwise we only need to match the first word against "permit"
  _match="permit"
  $nopass && _match="${_match} nopass"

  _key=""
  _value=""
  _doas_ressult=""
  # we need to test that all the sysctl(8) variable & value permutations are permitted
  for _cmd in "audio=0" "audio=1" "video=0" "video=1" ; do
    _key="${_cmd%%=*}"
    _value="${_cmd#*=}"
    _doas_result="$(doas -C /etc/doas.conf sysctl kern.${_key}.record=${_value})"

    # either "permit" or "permit nopass" are acceptable, except in non-interactive/nopass mode
    # easier to just match the first word against "permit"
    $nopass || _doas_result="${_doas_result%% *}"
    [ "$_doas_result" != "$_match" ] && _permitted=false
  done
  $_permitted
}

# parse argument
while getopts ahmnqtv arg ; do
  case "$arg" in
    h)
      usage && exit
      ;;
    a)
      audio=true
      ;;
    v)
      video=true
      ;;
    t)
      mode="toggle"
      ;;
    m)
      mode="monitor"
      ;;
    n)
      nopass=true
      ;;
    q)
      quiet="-q"
      ;;
    ?)
      usage && exit 2
      ;;
  esac
done
shift $((OPTIND - 1))
[ $# -gt 1 ] && usage && exit 2
case "$1" in
  1|yes|on|enable)
    state=1
    ;;
  0|no|off|disable)
    state=0
    ;;
  "")
    ;;
  *)
    usage && exit 2
    ;;
esac

# default to applying record state to both audio & video if neither was explicitly specified
if ! $audio && ! $video ; then
  audio=true
  video=true
fi

# default to toggling record state if no state was specified (and not monitoring)
if [ -z "$state" -a "$mode" != "monitor" ] ; then
  mode="toggle"
fi

# determine if user is permitted by doas(1) to set variables with sysctl(8) (root certainly is)
if [ "$mode" != "monitor" -a "$(id -u)" -ne 0 ] ; then
  # if doas(1) permits setting sysctl(8) variables, then use doas(1) to execute sysctl(8)
  if _is_sysctl_permitted ; then
    doas_cmd="doas"
    $nopass && doas_cmd="${doas_cmd} -n"
  else
    echo "$(basename "$0"): Operation not permitted" && exit 1
  fi
fi

# handle setting/toggling/monitoring recording state
case "$mode" in
  set)
    $audio && $doas_cmd sysctl $quiet kern.audio.record="$state"
    $video && $doas_cmd sysctl $quiet kern.video.record="$state"
    ;;
  toggle)
    $audio && $doas_cmd sysctl $quiet kern.audio.record="$(( ! $(sysctl -n kern.audio.record) ))"
    $video && $doas_cmd sysctl $quiet kern.video.record="$(( ! $(sysctl -n kern.video.record) ))"
    ;;
  monitor)
    echo "Not yet implemented! Exiting." && exit
    ;;
esac
